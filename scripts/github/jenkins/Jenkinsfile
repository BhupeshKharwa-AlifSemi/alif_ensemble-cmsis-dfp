pipeline {
    agent any
    options {
        skipDefaultCheckout(true)
    }
    stages {
        stage('Install Dependencies') {
            steps {
                script {
                    sh """#!/bin/bash -xe
                    echo -e "✔️ None."
                    """
                }
            }
        }
        stage('Environment') {
            steps {
                script {
                    sh """#!/bin/bash -xe
                        printenv
                        echo -e "✔️ Displayed all environment setting."
                    """
                }
            }
        }
        stage('checkout') {
            steps {
                script {
                    sh '''#!/bin/bash

                    repo_name="ensemble-cmsis-dfp_DEV"
                    license_status=$($ARMCLANG_PATH/../../bin/armlm inspect)

                    case "$license_status" in
                      *"No licenses found"*)
                        $ARMCLANG_PATH/../../bin/armlm activate --server http://10.10.60.10:7070 --product HWSKT-EAC0
                        ;;
                      *)
                        echo "ARM License is available."
                        ;;
                    esac

                    if [ -d $repo_name ]; then
                        echo -e "Deleting older repo $repo_name..."
                        rm -rf $repo_name
                    fi

                    CURR_OS=("NONE")
                    CURR_COMPILER=("armclang" "gcc")
                    CURR_DEV=("AE722F80F55D5" "AE1C1F4051920")
                    CURR_RTSS=("HE" "HP")
                    CURR_BOOT=("TCM" "MRAM")
                    total_cmakeError=0

                    echo -e "✔️ Checkout Repo 'ensemble-cmsis-dfp_DEV' main branch CHANGE_BRANCH: '$CHANGE_BRANCH' BRANCH_NAME: '$BRANCH_NAME'"
                    git clone org-115832732@github.com:AlifSemiDev/$repo_name.git
                    cd $repo_name
                    echo -e "✔️ Cloning is completed."
                    git log -4
                    echo -e "✔️ Checkout branch $CHANGE_BRANCH."
                    git checkout $CHANGE_BRANCH
                    git log -4
                    echo -e "✔️ Checkout is completed."
                    cd scripts/cmake
                    chmod -Rv 777 *.sh

                    total_cfg_run_cnt=0
                    skipped_cfg_run_cnt=0
                    actual_cfg_run_cnt=0

                    for comp in ${!CURR_COMPILER[@]}
                    do
                        for bootType in ${!CURR_BOOT[@]}
                        do
                            for rtssType in ${!CURR_RTSS[@]}
                            do
                                for devName in ${!CURR_DEV[@]}
                                do
                                    for osName in ${!CURR_OS[@]}
                                    do
                                        echo "===================================================================================="
                                        total_cfg_run_cnt=$((total_cfg_run_cnt + 1))
                                        echo "Building for ${CURR_COMPILER[comp]}, ${CURR_DEV[devName]}, ${CURR_OS[osName]}, ${CURR_BOOT[bootType]}  ${CURR_RTSS[rtssType]}"

                                        if [ "${CURR_DEV[devName]}" = "AE1C1F4051920" ] && [ "${CURR_RTSS[rtssType]}" = "HP" ]; then
                                            echo -e "${CURR_DEV[devName]} does not have ${CURR_RTSS[rtssType]} subsystem"
                                            skipped_cfg_run_cnt=$((skipped_cfg_run_cnt + 1))
                                            continue
                                        fi

                                        actual_cfg_run_cnt=$((actual_cfg_run_cnt + 1))
                                        ./run.sh -p ${CURR_COMPILER[comp]},${CURR_COMPILER[comp]}_build,${CURR_COMPILER[comp]}_build_test -c --fresh -DBOOT=${CURR_BOOT[bootType]} -DDEVICE=${CURR_DEV[devName]} -DOS=${CURR_OS[osName]} -DRTSS=${CURR_RTSS[rtssType]} -b --clean-first
                                        tmp=$?
                                        total_cmakeError=$((total_cmakeError + tmp))
                                        echo -e " Error Status total_cmakeError: $total_cmakeError and tmp: $tmp"
                                        echo "===================================================================================="
                                    done
                                done
                            done
                        done
                    done
                    echo -e " Total Run: ($actual_cfg_run_cnt/$total_cfg_run_cnt), skipped: $skipped_cfg_run_cnt"
                    exit $total_cmakeError
                    '''
                }
            }
        }
    }
}
